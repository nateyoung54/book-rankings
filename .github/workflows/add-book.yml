name: Add Book from Issue

on:
  issues:
    types: [opened, labeled]

jobs:
  add-book:
    if: contains(github.event.issue.labels.*.name, 'add-book')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue and update books.json
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Get issue body
            const body = context.payload.issue.body || '';
            const title = context.payload.issue.title || '';

            // Parse book details from issue body
            // Handles both "Field: Value" and GitHub form "### Field\n\nValue" formats
            const getField = (field) => {
              // Try "### Field\n\nValue" format (GitHub forms)
              const formRegex = new RegExp(`###\\s*${field}[^#]*?\\n\\n([^\\n#]+)`, 'i');
              const formMatch = body.match(formRegex);
              if (formMatch) return formMatch[1].trim();

              // Try "Field: Value" format
              const colonRegex = new RegExp(`${field}:\\s*(.+)`, 'i');
              const colonMatch = body.match(colonRegex);
              if (colonMatch) return colonMatch[1].trim();

              return null;
            };

            const bookTitle = getField('Title') || getField('Book') || title.replace(/^add:?\s*/i, '').trim();
            const author = getField('Author');
            const isbn = getField('ISBN') || getField('ISBN \\(optional\\)');
            const rankStr = getField('Rank');

            // Validate required fields
            if (!bookTitle || !author) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '❌ Missing required fields. Please include:\n\n```\nTitle: Book Name\nAuthor: Author Name\nRank: 1\n```\n\nISBN is optional.'
              });
              return;
            }

            // Read current books
            const booksFile = fs.readFileSync('books.json', 'utf8');
            const data = JSON.parse(booksFile);
            let books = data.books || [];

            // Determine rank
            let rank = rankStr ? parseInt(rankStr) : books.length + 1;
            if (isNaN(rank) || rank < 1) rank = books.length + 1;

            // Shift existing books at or below this rank
            books = books.map(book => {
              if (book.rank >= rank) {
                return { ...book, rank: book.rank + 1 };
              }
              return book;
            });

            // Create new book
            const newBook = { rank, title: bookTitle, author };
            if (isbn) {
              newBook.isbn = isbn.replace(/[-\s]/g, '');
            }

            // Add and sort
            books.push(newBook);
            books.sort((a, b) => a.rank - b.rank);

            // Write updated books.json
            fs.writeFileSync('books.json', JSON.stringify({ books }, null, 2) + '\n');

            // Store for commit message
            core.exportVariable('BOOK_TITLE', bookTitle);
            core.exportVariable('BOOK_AUTHOR', author);
            core.exportVariable('BOOK_RANK', rank);

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add books.json
          git commit -m "Add book: $BOOK_TITLE by $BOOK_AUTHOR (rank $BOOK_RANK)"
          git push

      - name: Comment and close issue
        uses: actions/github-script@v7
        with:
          script: |
            const rank = process.env.BOOK_RANK;
            const title = process.env.BOOK_TITLE;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ **${title}** added at rank ${rank}!\n\nYour site will update in about 30 seconds.`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
